from flask import Flask, request, render_template, redirect, url_for
import os
import subprocess
import re

app = Flask(__name__)

def check_port_443(scan_output):
    """ Check if port 443 is open in the Nmap scan output. """
    with open(scan_output, 'r') as file:
        contents = file.read()
    return '443/tcp open' in contents

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        url = request.form['url']
        sanitized_url = url.replace('/', '_').replace(':', '_')
        output_dir = f"./scans/{sanitized_url}"
        os.makedirs(output_dir, exist_ok=True)
        
        # Perform Nmap scan
        nmap_command = f"nmap -sS -sC -sV -p- -oA {output_dir}/output {url}"
        subprocess.run(nmap_command, shell=True)  # Run the Nmap scan
        
        # Check if port 443 is open
        if check_port_443(f"{output_dir}/output.nmap"):
            # Run sslscan if port 443 is open
            sslscan_command = f"sslscan {url}:443 > {output_dir}/sslscan_output.txt"
            subprocess.run(sslscan_command, shell=True)
        
        return redirect(url_for('scan_results', scan_id=sanitized_url))
    return render_template('index.html')

@app.route('/results/<scan_id>')
def scan_results(scan_id):
    output_files = os.listdir(f"./scans/{scan_id}")
    return render_template('results.html', files=output_files, scan_id=scan_id)

if __name__ == '__main__':
    app.run(debug=True)