#!/bin/bash

# Prompt for the client name
read -p "Enter the client name: " client_name

# Base directory for the structure
base_dir="./$client_name/nmap"

# Check if the base directory exists
if [ ! -d "$base_dir" ]; then
    echo "Base directory not found!"
    exit 1
fi

# Function to run whatweb scans
run_whatweb_scans() {
    for protocol in tcp udp; do
        protocol_dir="$base_dir/$protocol"
        if [ ! -d "$protocol_dir" ]; then
            echo "Protocol directory $protocol_dir not found!"
            continue
        fi

        for ip_dir in "$protocol_dir"/*
        do
            if [ -d "$ip_dir" ]; then
                ip=$(basename "$ip_dir" | tr '_' '.')
                for service_dir in "$ip_dir/Discovered_Ports"/*
                do
                    if [ -d "$service_dir" ]; then
                        for port_dir in "$service_dir"/*
                        do
                            if [ -d "$port_dir" ]; then
                                port=$(basename "$port_dir")
                                whatweb_dir="$port_dir/whatweb"
                                mkdir -p "$whatweb_dir"
                                url="http://$ip:$port"
                                echo "Running whatweb on $url"
                                whatweb -a 3 "$url" > "$whatweb_dir/whatweb_output.txt"
                                echo "WhatWeb output saved to $whatweb_dir/whatweb_output.txt"
                            fi
                        done
                    fi
                done
            fi
        done
    done
}

# Function to run nikto scans
run_nikto_scans() {
    for protocol in tcp udp; do
        protocol_dir="$base_dir/$protocol"
        if [ ! -d "$protocol_dir" ]; then
            echo "Protocol directory $protocol_dir not found!"
            continue
        fi

        for ip_dir in "$protocol_dir"/*
        do
            if [ -d "$ip_dir" ]; then
                ip=$(basename "$ip_dir" | tr '_' '.')
                for service_dir in "$ip_dir/Discovered_Ports"/*
                do
                    if [ -d "$service_dir" ]; then
                        for port_dir in "$service_dir"/*
                        do
                            if [ -d "$port_dir" ]; then
                                port=$(basename "$port_dir")
                                nikto_dir="$port_dir/nikto"
                                mkdir -p "$nikto_dir"
                                url="http://$ip:$port"
                                echo "Running nikto on $url"
                                nikto -h "$url" > "$nikto_dir/nikto_output.txt"
                                echo "Nikto output saved to $nikto_dir/nikto_output.txt"
                            fi
                        done
                    fi
                done
            fi
        done
    done
}

# Run all whatweb scans first
run_whatweb_scans

# Run all nikto scans next
run_nikto_scans

echo "Web scans (WhatWeb and Nikto) completed for all IP:PORT combinations."
