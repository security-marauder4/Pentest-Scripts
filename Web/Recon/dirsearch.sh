#!/bin/bash

# Prompt for the client name
read -p "Enter the client name: " client_name

# Base directory for the structure
base_dir="./$client_name/nmap"

# Check if the base directory exists
if [ ! -d "$base_dir" ]; then
    echo "Base directory not found!"
    exit 1
fi

# Common web extensions (reduced to most important ones)
WEB_EXTENSIONS="php,asp,aspx,jsp,html"

# Function to run dirsearch scans
run_dirsearch_scans() {
    for protocol in tcp udp; do
        protocol_dir="$base_dir/$protocol"
        if [ ! -d "$protocol_dir" ]; then
            echo "Protocol directory $protocol_dir not found!"
            continue
        fi

        for ip_dir in "$protocol_dir"/*
        do
            if [ -d "$ip_dir" ]; then
                ip=$(basename "$ip_dir" | tr '_' '.')
                for service_dir in "$ip_dir/Discovered_Ports"/*
                do
                    if [ -d "$service_dir" ]; then
                        protocol=$(basename "$service_dir")
                        # Only scan web-related services
                        if [[ "$protocol" =~ ^(http|https|www|ssl)$ ]]; then
                            for port_dir in "$service_dir"/*
                            do
                                if [ -d "$port_dir" ]; then
                                    port=$(basename "$port_dir")
                                    dirsearch_dir="$port_dir/dirsearch"
                                    mkdir -p "$dirsearch_dir"
                                    url="$protocol://$ip:$port"
                                    
                                    echo "Running dirsearch on $url"
                                    
                                    # Enhanced dirsearch scan with responsible settings
                                    dirsearch -u "$url" \
                                        -e "$WEB_EXTENSIONS" \
                                        -t 10 \
                                        -r \
                                        --random-agent \
                                        -i 200,201,202,203,204,301,302,307,401,403 \
                                        -o "$dirsearch_dir/dirsearch_output.txt" \
                                        --format=json \
                                        -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt \
                                        --delay=0.5 \
                                        --timeout=10 \
                                        --max-rate=40 \
                                        --exclude-status=429

                                    # Create a summary file
                                    echo "Scan Summary for $url" > "$dirsearch_dir/scan_summary.txt"
                                    echo "Timestamp: $(date)" >> "$dirsearch_dir/scan_summary.txt"
                                    echo "----------------------------------------" >> "$dirsearch_dir/scan_summary.txt"
                                    
                                    # Extract interesting findings
                                    grep -E "200|301|302|401|403" "$dirsearch_dir/dirsearch_output.txt" > "$dirsearch_dir/interesting_findings.txt"
                                    
                                    echo "Dirsearch output saved to $dirsearch_dir/"
                                fi
                            done
                        fi
                    fi
                done
            fi
        done
    done
}

# Run all dirsearch scans
run_dirsearch_scans

echo "Web scans (Dirsearch) completed for all IP:PORT combinations."