#!/bin/bash

# Check if the user has provided an input file
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 ip_list.txt"
    exit 1
fi

# Assign the first argument to the variable 'file'
file=$1

# Check if the file exists
if [ ! -f "$file" ]; then
    echo "File not found!"
    exit 1
fi

# Base directory for the structure
base_dir="./job/Nmap/TCP/Full"

# Read the file line by line
while IFS= read -r ip
do
    # Skip empty lines
    if [ -z "$ip" ]; then
        continue
    fi

    # Replace dots in IP address with underscores for the filename
    filename=$(echo "$ip" | tr '.' '_')

    # Create a directory for the IP under the relevant base directory
    ip_dir="$base_dir/$filename"
    mkdir -p "$ip_dir"

    # Perform nmap scan on all TCP ports for the given IP and save the output to a temporary file
    echo "Scanning IP: $ip"
    nmap_output=$(nmap -sS -sC -sV -p- -v10 -oA "$ip_dir/output_$filename" "$ip")
    echo "$nmap_output" > "$ip_dir/output_$filename.nmap"

    # Parse the nmap output to find open services and create directories for each
    echo "$nmap_output" | grep '/open/' | awk '{print $3}' | while read service
    do
        service_dir=$(echo $service | cut -d'/' -f1)  # Extract the service name
        mkdir -p "$ip_dir/$service_dir"  # Create a directory for the service
        echo "Directory created for $service at $ip_dir/$service_dir"
    done
done < "$file"

echo "Nmap scan completed. Results saved to individual output files and directories for services."