#!/bin/bash

# Check if the user has provided an input file
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 ip_list.txt"
    exit 1
fi

# Assign the first argument to the variable 'file'
file=$1

# Check if the file exists
if [ ! -f "$file" ]; then
    echo "File not found!"
    exit 1
fi

# Base directory for the structure
base_dir="./job/Nmap/TCP/Full"

# Read the file line by line
while IFS= read -r ip
do
    # Skip empty lines
    if [ -z "$ip" ]; then
        continue
    fi

    # Replace dots in IP address with underscores for the filename
    filename=$(echo "$ip" | tr '.' '_')

    # Create a directory for the IP under the relevant base directory
    ip_dir="$base_dir/$filename"
    mkdir -p "$ip_dir"

    # Perform nmap scan on all TCP ports for the given IP and save the output to a file
    echo "Scanning IP: $ip"
    nmap -sS -sC -sV -p- -oA "$ip_dir/output_$filename" "$ip"

    # Create a directory for discovered ports
    discovered_ports_dir="$ip_dir/Discovered_Ports"
    mkdir -p "$discovered_ports_dir" || { echo "Failed to create directory $discovered_ports_dir"; exit 1; }

    # Since the output is already saved, we can directly read from the file for further processing
    grep 'tcp' "$ip_dir/output_$filename.nmap" | grep 'open' | while read -r line
    do
        echo "Processing line: $line"  # Debug statement
        port=$(echo "$line" | awk '{print $1}' | cut -d'/' -f1)
        service=$(echo "$line" | awk '{print $3}')
        service_name=$(echo "$service" | cut -d'/' -f1)  # Extract the service name
        service_dir="$discovered_ports_dir/$service_name"  # Directory for the service
        port_dir="$service_dir/$port"  # Directory for the port under the service directory
        mkdir -p "$port_dir" || { echo "Failed to create directory for $service at $port_dir"; continue; }
        echo "Directory created for $service at $port_dir"  # Debug statement
    done
done < "$file"

echo "Nmap scan completed. Results saved to individual output files and directories for services."