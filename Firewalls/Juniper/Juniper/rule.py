import re
import csv
import sys

def parse_juniper_config(file_path):
    # Read the configuration file
    with open(file_path, 'r') as file:
        config_text = file.read()
    
    # Updated regex pattern to capture policy details and logs
    pattern = re.compile(
        r'policy\s+(\S+)\s*{\s*match\s*{\s*source-address\s+(\S+);\s*destination-address\s+(\S+);\s*application\s+(\S+);\s*}\s*then\s*{\s*\S+;\s*(log\s*{\s*[^}]*\s*})?\s*}\s*}',
        re.DOTALL
    )
    
    # Find all matches in the configuration text
    matches = pattern.findall(config_text)
    
    # Prepare the data for CSV
    csv_data = [["Policy Name", "Source", "Destination", "Application", "Log"]]
    for match in matches:
        policy_name, source, destination, application, log = match
        # Determine if logging is enabled
        log_status = "Enabled" if log else "Disabled"
        # Append data to CSV
        csv_data.append([policy_name, source, destination, application, log_status])
    
    return csv_data

def write_to_csv(data, filename):
    with open(filename, 'w', newline='') as file:
        writer = csv.writer(file)
        writer.writerows(data)

# Main execution
if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python3 rule.py <configfile> <csvfile>")
        sys.exit(1)
    
    config_file_path = sys.argv[1]
    csv_output_path = sys.argv[2]

    csv_data = parse_juniper_config(config_file_path)
    write_to_csv(csv_data, csv_output_path)