#!/bin/bash

# Function to parse Dirsearch output and save discovered directories in a readable text format
parse_dirsearch_output() {
    local dirsearch_output_file="$1"
    local directories_file="$2"
    
    echo "Parsing Dirsearch output from $dirsearch_output_file"
    
    # Extract lines that indicate discovered directories
    local directories=()
    while IFS= read -r line; do
        directories+=("$(echo "$line" | sed 's/^.*\[200\] //')")
    done < <(grep -E '\[200\]' "$dirsearch_output_file")
    
    if [ ${#directories[@]} -gt 0 ]; then
        local url=$(basename "$(dirname "$(dirname "$(dirname "$(dirname "$(dirname "$dirsearch_output_file")")")")")")
        local port=$(basename "$(dirname "$(dirname "$dirsearch_output_file")")")
        
        # Output the information in a readable format
        echo "URL: $url" >> "$directories_file"
        echo "Port: $port" >> "$directories_file"
        echo "Discovered Directories:" >> "$directories_file"
        for directory in "${directories[@]}"; do
            echo "  - $directory" >> "$directories_file"
        done
        echo "----------------------------------------" >> "$directories_file"
    fi
    
    echo "Discovered directories saved to $directories_file"
}

# Base directory for the structure
read -p "Enter the client name: " client_name
base_dir="./$client_name/nmap"

# Check if the base directory exists
if [ ! -d "$base_dir" ]; then
    echo "Base directory not found!"
    exit 1
fi

# Create a vulnerabilities directory if it doesn't exist
vulnerabilities_dir="./$client_name/vulnerabilities"
mkdir -p "$vulnerabilities_dir"

# Create a text file for the directories report
output_txt="$vulnerabilities_dir/dirsearch_results.txt"
echo "Directories Report" > "$output_txt"
echo "==================" >> "$output_txt"

# Iterate over all Dirsearch output files and parse them
for protocol in tcp udp; do
    protocol_dir="$base_dir/$protocol"
    if [ ! -d "$protocol_dir" ]; then
        echo "Protocol directory $protocol_dir not found!"
        continue
    fi

    for url_dir in "$protocol_dir"/*
    do
        if [ -d "$url_dir" ]; then
            url=$(basename "$url_dir")
            for service_dir in "$url_dir/Discovered_Ports"/*
            do
                if [ -d "$service_dir" ]; then
                    for port_dir in "$service_dir"/*
                    do
                        if [ -d "$port_dir" ]; then
                            port=$(basename "$port_dir")
                            dirsearch_dir="$port_dir/dirsearch"
                            dirsearch_output_file="$dirsearch_dir/dirsearch_output.txt"
                            directories_file="$output_txt"
                            
                            if [ -f "$dirsearch_output_file" ]; then
                                parse_dirsearch_output "$dirsearch_output_file" "$directories_file"
                            else
                                echo "Dirsearch output file $dirsearch_output_file not found!"
                            fi
                        fi
                    done
                fi
            done
        fi
    done
done

echo "Dirsearch output parsing completed for all URL:PORT combinations."
echo "Directories report saved to $output_txt"